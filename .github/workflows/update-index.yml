name: Update Agent Index

on:
  push:
    branches: [main]
    paths:
      - 'agents/*/agent.json'

jobs:
  update-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Generate index.json
        run: |
          echo '[' > agents/index.json.tmp
          first=true
          for dir in agents/*/; do
            if [ -f "${dir}agent.json" ]; then
              slug=$(basename "$dir")
              agent=$(cat "${dir}agent.json" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)['agent']
          entry = {
            'slug': data['slug'],
            'name': data['name'],
            'description': data['description'],
            'icon': data['icon'],
            'category': data['category'],
            'author': data['author'],
            'tags': data.get('tags', []),
            'updatedAt': data.get('updatedAt', '')
          }
          print(json.dumps(entry, ensure_ascii=False))
          ")
              if [ "$first" = true ]; then
                first=false
              else
                echo ',' >> agents/index.json.tmp
              fi
              echo "  $agent" >> agents/index.json.tmp
            fi
          done
          echo '' >> agents/index.json.tmp
          echo ']' >> agents/index.json.tmp
          python3 -c "import json; data=json.load(open('agents/index.json.tmp')); json.dump(data, open('agents/index.json','w'), indent=2, ensure_ascii=False)"
          rm agents/index.json.tmp

      - name: Commit updated index
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add agents/index.json
          git diff --cached --quiet || git commit -m "chore: update agent index"
          git push
